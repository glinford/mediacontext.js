!function(){"use strict";function a(a){var d=c(b,a||{});this.init(d)}var b={mediaSelector:".media-context",backgroundSelector:".media-context-background",backgroundContext:{json:{path:null},manual:{}},metadataSelector:".media-context-metadata",metadataContext:{json:{path:null},manual:[]}},c=function(a,b){var c={};for(var d in a)c[d]=a[d];for(var e in b)c[e]=b[e];return c};a.prototype={backgroundElement:null,mediaElement:null,metadatablockElement:null,events:{background:[],metadata:[]},settings:null,cssString:"",preLoadBackgrounds:function(){var a="body:after{position:absolute; width:0; height:0; overflow:hidden; z-index:-1;content: "+this.cssString+";}",b=document.head||document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css",c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.appendChild(c)},imageExists:function(a,b){var c=new Image;c.onload=function(){b(!0)},c.onerror=function(){b(!1)},c.src=a},loadJSON:function(a,b){var c=new XMLHttpRequest;c.overrideMimeType("application/json"),c.open("GET",a,!0),c.onreadystatechange=function(){4==c.readyState&&"200"==c.status&&b(c.responseText)},c.send(null)},init:function(a){this.settings=a,this.mediaElement=document.querySelector(a.mediaSelector),this.backgroundElement=document.querySelector(a.backgroundSelector),this.metadatablockElement=document.querySelector(a.metadataSelector),this.mediaElement&&this.mediaElement.addEventListener("canplay",function(){this.prepareBackground(function(){this.prepareMetadata(function(){this.prepareMedia()}.bind(this))}.bind(this))}.bind(this))},prepareBackground:function(a){this.backgroundElement||a();var b=function(c){if(c<this.settings.backgroundContext.manual.length){var d=this.settings.backgroundContext.manual[c];this.imageExists(d.src,function(a){return a&&(this.cssString+="url("+d.src+") ",this.events.background[d.time]="url('"+d.src+"')"),b(c+1)}.bind(this))}else a()}.bind(this);this.settings.backgroundContext.json&&this.settings.backgroundContext.json.path?this.loadJSON(this.settings.backgroundContext.json.path,function(a){var c=JSON.parse(a);"undefined"!=typeof c&&(this.settings.backgroundContext.manual=c.concat(this.settings.backgroundContext.manual||[]),b(0))}.bind(this)):this.settings.backgroundContext.manual.length?b(0):a()},prepareMetadata:function(a){this.metadatablockElement||a(),this.settings.metadataContext.manual&&this.settings.metadataContext.manual.length&&this.settings.metadataContext.manual.forEach(function(a){"undefined"!=typeof a.time&&(this.events.metadata[a.time]=a.content)}.bind(this)),this.settings.metadataContext.json&&this.settings.metadataContext.json.path?this.loadJSON(this.settings.metadataContext.json.path,function(b){var c=JSON.parse(b);c.forEach(function(a){"undefined"!=typeof a.time&&(this.events.metadata[a.time]={html:a.content,duration:a.duration})}.bind(this)),a()}.bind(this)):a()},prepareMedia:function(){this.mediaElement.addEventListener("timeupdate",function(){var a=Math.round(this.mediaElement.currentTime),b=this.events.background[a];b&&(this.backgroundElement.style.backgroundImage=b);var c=this.events.metadata[a];c&&(this.metadatablockElement.style.opacity=0,this.metadatablockElement.innerHTML=c.html,this.metadatablockElement.style.opacity=1,c.duration&&setTimeout(function(){this.metadatablockElement.style.opacity=0}.bind(this),1e3*c.duration))}.bind(this)),this.preLoadBackgrounds()}};var d=function(b){return new a(b)};return"function"==typeof define&&define.amd&&define("MediaContext",[],function(){return d}),self.MediaContext=d,d}();